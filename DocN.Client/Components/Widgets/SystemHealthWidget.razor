@using DocN.Data.Services
@using DocN.Data.Models
@using System.Security.Claims
@inject IDocumentStatisticsService StatisticsService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILogger<SystemHealthWidget> Logger

<div class="widget-card system-health-widget">
    <div class="widget-header">
        <h3>üíö @Title</h3>
    </div>

    @if (_loading)
    {
        <div class="widget-loading">Caricamento...</div>
    }
    else if (_error != null)
    {
        <div class="widget-error">@_error</div>
    }
    else
    {
        <div class="health-sections">
            <!-- Processing Queue Status -->
            <div class="health-section">
                <h4>‚öôÔ∏è Coda Elaborazione</h4>
                <div class="health-stats">
                    <div class="health-stat">
                        <span>In Coda</span>
                        <span class="stat-badge warning">@_healthStatus.PendingDocuments</span>
                    </div>
                    <div class="health-stat">
                        <span>In Elaborazione</span>
                        <span class="stat-badge info">@_healthStatus.ProcessingDocuments</span>
                    </div>
                    <div class="health-stat">
                        <span>Falliti</span>
                        <span class="stat-badge @(_healthStatus.FailedDocuments > 0 ? "error" : "")">@_healthStatus.FailedDocuments</span>
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="health-section">
                <h4>üñ•Ô∏è Stato Sistema</h4>
                <div class="health-stats">
                    <div class="health-stat">
                        <span>Database</span>
                        <span class="status-badge @GetStatusClass(_healthStatus.DatabaseStatus)">@_healthStatus.DatabaseStatus</span>
                    </div>
                    <div class="health-stat">
                        <span>Servizio AI</span>
                        <span class="status-badge @GetStatusClass(_healthStatus.AIServiceStatus)">@_healthStatus.AIServiceStatus</span>
                    </div>
                    <div class="health-stat">
                        <span>Storage</span>
                        <span class="status-badge @GetStatusClass(_healthStatus.StorageStatus)">@_healthStatus.StorageStatus</span>
                    </div>
                </div>
            </div>

            <div class="last-update">
                Ultimo aggiornamento: @_lastUpdate.ToString("HH:mm:ss")
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string Title { get; set; } = "Stato Sistema";

    [Parameter]
    public int WidgetId { get; set; }

    private SystemHealthStatus _healthStatus = new();
    private bool _loading = true;
    private string? _error;
    private DateTime _lastUpdate = DateTime.Now;

    protected override async Task OnInitializedAsync()
    {
        await LoadHealthStatusAsync();
    }

    private async Task LoadHealthStatusAsync()
    {
        try
        {
            _loading = true;
            _error = null;

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                _error = "Utente non autenticato";
                return;
            }

            // Get health status from document statistics
            var stats = await StatisticsService.GetStatisticsAsync(userId);
            
            _healthStatus = new SystemHealthStatus
            {
                PendingDocuments = stats.PendingEmbeddingsCount,
                ProcessingDocuments = stats.ProcessingEmbeddingsCount,
                FailedDocuments = 0,
                DatabaseStatus = "Healthy",
                AIServiceStatus = stats.CompletedEmbeddingsCount > 0 ? "Healthy" : "Unknown",
                StorageStatus = "Healthy"
            };

            _lastUpdate = DateTime.Now;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading system health status");
            _error = "Errore nel caricamento stato sistema";
            _healthStatus.DatabaseStatus = "Error";
        }
        finally
        {
            _loading = false;
        }
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "healthy" => "success",
            "warning" => "warning",
            "error" => "error",
            _ => ""
        };
    }

    private class SystemHealthStatus
    {
        public int PendingDocuments { get; set; }
        public int ProcessingDocuments { get; set; }
        public int FailedDocuments { get; set; }
        public string DatabaseStatus { get; set; } = "Unknown";
        public string AIServiceStatus { get; set; } = "Unknown";
        public string StorageStatus { get; set; } = "Unknown";
    }
}

<style>
    .widget-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        height: 100%;
    }

    .widget-header h3 {
        margin: 0 0 1.5rem 0;
        font-size: 1.2rem;
        color: #333;
    }

    .widget-loading {
        text-align: center;
        padding: 2rem;
        color: #666;
    }

    .widget-error {
        padding: 1rem;
        background: #f8d7da;
        color: #721c24;
        border-radius: 5px;
    }

    .health-sections {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .health-section h4 {
        margin: 0 0 0.75rem 0;
        font-size: 0.95rem;
        color: #666;
    }

    .health-stats {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .health-stat {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
    }

    .stat-badge {
        background: #e9ecef;
        color: #666;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .stat-badge.warning {
        background: #fff3cd;
        color: #856404;
    }

    .stat-badge.info {
        background: #cfe2ff;
        color: #084298;
    }

    .stat-badge.error {
        background: #f8d7da;
        color: #721c24;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .status-badge.success {
        background: #d1e7dd;
        color: #0a3622;
    }

    .status-badge.warning {
        background: #fff3cd;
        color: #856404;
    }

    .status-badge.error {
        background: #f8d7da;
        color: #721c24;
    }

    .last-update {
        text-align: center;
        font-size: 0.75rem;
        color: #999;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }
</style>
