@using DocN.Data.Services
@using DocN.Data.Models
@using Microsoft.AspNetCore.Components
@using Microsoft.FluentUI.AspNetCore.Components
@using System.Security.Claims
@inject IDocumentService DocumentService
@inject ILogger<RecentDocumentsWidget> Logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager

<FluentCard Class="widget-card recent-documents-widget">
    <FluentStack Orientation="Orientation.Vertical" Style="gap: 1rem;">
        <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
            <FluentIcon Value="@(new string.DocumentMultiple())" Color="Color.Accent" />
            <FluentLabel Typo="Typography.H6">@Title</FluentLabel>
        </FluentStack>

        @if (_loading)
        {
            <FluentProgressRing />
        }
        else if (_error != null)
        {
            <FluentMessageBar Intent="MessageIntent.Error">
                @_error
            </FluentMessageBar>
        }
        else if (_documents?.Any() == true)
        {
            <FluentStack Orientation="Orientation.Vertical" Style="gap: 0.75rem;">
                @foreach (var document in _documents)
                {
                    <FluentCard Class="document-item" @onclick="() => NavigateToDocument(document.Id)">
                        <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center" Style="gap: 1rem;">
                            <FluentIcon Value="@GetDocumentIcon(document.ContentType ?? "")" Color="Color.Neutral" />
                            <FluentStack Orientation="Orientation.Vertical" Style="gap: 0.25rem; flex: 1;">
                                <FluentLabel Typo="Typography.Body" Style="font-weight: 500;">@document.FileName</FluentLabel>
                                <FluentLabel Typo="Typography.Caption" Color="Color.Neutral">
                                    @document.UploadedAt.ToString("MMM dd, yyyy HH:mm")
                                    @if (!string.IsNullOrEmpty(document.ActualCategory))
                                    {
                                        <span> â€¢ @document.ActualCategory</span>
                                    }
                                </FluentLabel>
                            </FluentStack>
                            @if (document.FileSize > 0)
                            {
                                <FluentBadge Appearance="Appearance.Neutral">@FormatFileSize(document.FileSize)</FluentBadge>
                            }
                        </FluentStack>
                    </FluentCard>
                }
            </FluentStack>
        }
        else
        {
            <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" Style="padding: 2rem;">
                <FluentIcon Value="@(new string.DocumentMultiple())" Color="Color.Neutral" />
                <FluentLabel Typo="Typography.Body" Color="Color.Neutral">No recent documents</FluentLabel>
            </FluentStack>
        }
    </FluentStack>
</FluentCard>

@code {
    [Parameter]
    public string Title { get; set; } = "Recent Documents";

    [Parameter]
    public int WidgetId { get; set; }

    [Parameter]
    public int MaxCount { get; set; } = 5;

    private List<Document>? _documents;
    private bool _loading = true;
    private string? _error;
    private string? _userId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);
        await LoadDocumentsAsync();
    }

    private async Task LoadDocumentsAsync()
    {
        try
        {
            _loading = true;
            _error = null;

            if (string.IsNullOrEmpty(_userId))
            {
                _error = "User not authenticated";
                return;
            }

            // Get recent documents (last MaxCount uploaded)
            _documents = (await DocumentService.GetUserDocumentsAsync(_userId, 1, MaxCount))
                .OrderByDescending(d => d.UploadedAt)
                .ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading recent documents");
            _error = "Failed to load recent documents";
        }
        finally
        {
            _loading = false;
        }
    }

    private void NavigateToDocument(int documentId)
    {
        NavigationManager.NavigateTo($"/documents/{documentId}");
    }

    private string GetDocumentIcon(string contentType)
    {
        return contentType.ToLower() switch
        {
            var ct when ct.Contains("pdf") => new string.DocumentPdf(),
            var ct when ct.Contains("word") || ct.Contains("docx") => new string.DocumentText(),
            var ct when ct.Contains("excel") || ct.Contains("spreadsheet") => new string.DocumentTable(),
            var ct when ct.Contains("image") => new string.Image(),
            var ct when ct.Contains("text") => new string.DocumentText(),
            _ => new string.Document()
        };
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}

<style>
    .widget-card {
        padding: 1.5rem;
        height: 100%;
    }

    .recent-documents-widget {
        min-height: 300px;
    }

    .document-item {
        padding: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .document-item:hover {
        background-color: var(--neutral-layer-2);
        transform: translateX(4px);
    }
</style>
