@page "/admin/role-management"
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Authorization
@using DocN.Data.Constants
@using DocN.Client.Components.Admin
@inject IHttpClientFactory HttpClientFactory
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer
@attribute [Authorize(Roles = "SuperAdmin,TenantAdmin")]

<PageTitle>Gestione Ruoli - DocN</PageTitle>

<div class="role-management-page">
    <div class="page-header">
        <h1>üîê Gestione Ruoli e Permessi</h1>
        <p class="page-subtitle">Gestisci i ruoli degli utenti e visualizza le statistiche</p>
    </div>
    
    <!-- User Statistics -->
    @if (stats != null)
    {
        <UserStatsWidget 
            TotalUsers="@stats.TotalUsers"
            ActiveUsers="@stats.ActiveUsers"
            InactiveUsers="@stats.InactiveUsers"
            RoleStats="@stats.RoleDistribution" />
    }
    
    <!-- Search and Filter -->
    <div class="filters-section">
        <div class="search-box">
            <input type="text" 
                   placeholder="Cerca per nome o email..." 
                   @bind="searchTerm"
                   @bind:event="oninput"
                   @onkeyup="OnSearchKeyUp"
                   class="search-input" />
        </div>
        
        <div class="filter-group">
            <label>Filtra per Ruolo:</label>
            <select @bind="roleFilter" @bind:after="LoadUsers" class="filter-select">
                <option value="">Tutti i Ruoli</option>
                @foreach (var role in Roles.All)
                {
                    <option value="@role">@role</option>
                }
            </select>
        </div>
        
        @if (selectedUserIds.Any())
        {
            <div class="bulk-actions">
                <button class="btn-bulk" @onclick="ShowBulkRoleDialog">
                    Cambia Ruolo (@selectedUserIds.Count selezionati)
                </button>
            </div>
        }
    </div>
    
    <!-- Users Table -->
    @if (isLoading)
    {
        <div class="loading">Caricamento...</div>
    }
    else if (users.Any())
    {
        <div class="users-table-container">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" 
                                   @onchange="ToggleSelectAll" 
                                   checked="@(selectedUserIds.Count == users.Count)" />
                        </th>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Ruolo</th>
                        <th>Ultimo Accesso</th>
                        <th>Stato</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in users)
                    {
                        <tr class="@(selectedUserIds.Contains(user.Id) ? "selected" : "")">
                            <td>
                                <input type="checkbox" 
                                       checked="@selectedUserIds.Contains(user.Id)"
                                       @onchange="() => ToggleUserSelection(user.Id)" />
                            </td>
                            <td>@($"{user.FirstName} {user.LastName}")</td>
                            <td>@user.Email</td>
                            <td>
                                <span class="role-badge role-@user.Role.ToLower()">
                                    @user.Role
                                </span>
                            </td>
                            <td>@FormatLastLogin(user.LastLoginAt)</td>
                            <td>
                                <span class="status-badge @(user.IsActive ? "active" : "inactive")">
                                    @(user.IsActive ? "Attivo" : "Inattivo")
                                </span>
                            </td>
                            <td>
                                <button class="btn-action" @onclick="() => ShowRoleDialog(user)">
                                    ‚úèÔ∏è Cambia Ruolo
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <div class="pagination">
                <button class="page-btn" 
                        @onclick="() => ChangePage(currentPage - 1)"
                        disabled="@(currentPage <= 1)">
                    ¬´ Precedente
                </button>
                
                <span class="page-info">Pagina @currentPage di @totalPages</span>
                
                <button class="page-btn" 
                        @onclick="() => ChangePage(currentPage + 1)"
                        disabled="@(currentPage >= totalPages)">
                    Successiva ¬ª
                </button>
            </div>
        }
    }
    else
    {
        <div class="no-data">Nessun utente trovato</div>
    }
    
    <!-- Role Dialog -->
    @if (selectedUser != null)
    {
        <RoleDialog 
            IsOpen="@showRoleDialog"
            UserId="@selectedUser.Id"
            UserEmail="@selectedUser.Email"
            CurrentRole="@selectedUser.Role"
            OnClose="CloseRoleDialog"
            OnRoleChanged="HandleRoleChange" />
    }
    
    <!-- Success/Error Messages -->
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="toast success">
            ‚úì @successMessage
        </div>
    }
    
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="toast error">
            ‚úó @errorMessage
        </div>
    }
</div>

@code {
    private List<UserInfo> users = new();
    private UserInfo? selectedUser = null;
    private List<string> selectedUserIds = new();
    private bool showRoleDialog = false;
    private bool isLoading = true;
    private string searchTerm = string.Empty;
    private string roleFilter = string.Empty;
    private int currentPage = 1;
    private int pageSize = 30;
    private int totalPages = 1;
    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;
    private StatsInfo? stats = null;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadStats();
        await LoadUsers();
    }
    
    private async Task LoadStats()
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("BackendAPI");
            var response = await httpClient.GetFromJsonAsync<StatsResponse>("/api/usermanagement/role-stats");
            
            if (response != null)
            {
                stats = new StatsInfo
                {
                    TotalUsers = response.TotalUsers,
                    ActiveUsers = response.ActiveUsers,
                    InactiveUsers = response.InactiveUsers,
                    RoleDistribution = response.RoleDistribution
                };
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading stats: {ex.Message}");
        }
    }
    
    private async Task LoadUsers()
    {
        isLoading = true;
        try
        {
            var httpClient = HttpClientFactory.CreateClient("BackendAPI");
            var url = $"/api/usermanagement?page={currentPage}&pageSize={pageSize}";
            
            if (!string.IsNullOrWhiteSpace(searchTerm))
                url += $"&searchTerm={Uri.EscapeDataString(searchTerm)}";
            
            if (!string.IsNullOrWhiteSpace(roleFilter))
                url += $"&roleFilter={Uri.EscapeDataString(roleFilter)}";
            
            var response = await httpClient.GetFromJsonAsync<UsersResponse>(url);
            
            if (response != null)
            {
                users = response.Users;
                totalPages = response.TotalPages;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Errore nel caricamento utenti: {ex.Message}";
            AutoHideMessage();
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            currentPage = 1;
            await LoadUsers();
        }
    }
    
    private async Task ChangePage(int page)
    {
        currentPage = page;
        await LoadUsers();
    }
    
    private void ShowRoleDialog(UserInfo user)
    {
        selectedUser = user;
        showRoleDialog = true;
    }
    
    private void ShowBulkRoleDialog()
    {
        if (selectedUserIds.Any())
        {
            // For bulk, we'll use a simplified dialog
            // In a full implementation, you'd want a dedicated bulk dialog
            var firstUser = users.FirstOrDefault(u => selectedUserIds.Contains(u.Id));
            if (firstUser != null)
            {
                selectedUser = firstUser;
                showRoleDialog = true;
            }
        }
    }
    
    private async Task CloseRoleDialog()
    {
        showRoleDialog = false;
        selectedUser = null;
    }
    
    private async Task HandleRoleChange(string newRole)
    {
        if (selectedUser == null) return;
        
        try
        {
            var httpClient = HttpClientFactory.CreateClient("BackendAPI");
            
            if (selectedUserIds.Count > 1 && selectedUserIds.Contains(selectedUser.Id))
            {
                // Bulk change
                var bulkRequest = new
                {
                    userIds = selectedUserIds,
                    newRole = newRole
                };
                
                var response = await httpClient.PostAsJsonAsync("/api/usermanagement/bulk-change-roles", bulkRequest);
                
                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<BulkChangeResponse>();
                    successMessage = result?.Message ?? "Ruoli cambiati con successo";
                    selectedUserIds.Clear();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    errorMessage = $"Errore nel cambio ruoli: {error}";
                }
            }
            else
            {
                // Single change
                var response = await httpClient.PostAsJsonAsync(
                    $"/api/usermanagement/{selectedUser.Id}/change-role",
                    new { newRole = newRole });
                
                if (response.IsSuccessStatusCode)
                {
                    successMessage = "Ruolo cambiato con successo";
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    errorMessage = $"Errore nel cambio ruolo: {error}";
                }
            }
            
            await LoadUsers();
            await LoadStats();
            AutoHideMessage();
        }
        catch (Exception ex)
        {
            errorMessage = $"Errore: {ex.Message}";
            AutoHideMessage();
        }
    }
    
    private void ToggleUserSelection(string userId)
    {
        if (selectedUserIds.Contains(userId))
            selectedUserIds.Remove(userId);
        else
            selectedUserIds.Add(userId);
    }
    
    private void ToggleSelectAll(ChangeEventArgs e)
    {
        if (e.Value is bool isChecked && isChecked)
        {
            selectedUserIds = users.Select(u => u.Id).ToList();
        }
        else
        {
            selectedUserIds.Clear();
        }
    }
    
    private string FormatLastLogin(DateTime? lastLogin)
    {
        if (lastLogin == null) return "Mai";
        
        var diff = DateTime.UtcNow - lastLogin.Value;
        
        if (diff.TotalDays < 1) return "Oggi";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays} giorni fa";
        if (diff.TotalDays < 30) return $"{(int)(diff.TotalDays / 7)} settimane fa";
        
        return lastLogin.Value.ToString("dd/MM/yyyy");
    }
    
    private async void AutoHideMessage()
    {
        await Task.Delay(5000);
        successMessage = string.Empty;
        errorMessage = string.Empty;
        StateHasChanged();
    }
    
    private class UserInfo
    {
        public string Id { get; set; } = string.Empty;
        public string? Email { get; set; }
        public string? FirstName { get; set; }
        public string? LastName { get; set; }
        public string Role { get; set; } = string.Empty;
        public DateTime? LastLoginAt { get; set; }
        public bool IsActive { get; set; }
    }
    
    private class UsersResponse
    {
        public List<UserInfo> Users { get; set; } = new();
        public int TotalCount { get; set; }
        public int Page { get; set; }
        public int PageSize { get; set; }
        public int TotalPages { get; set; }
    }
    
    private class StatsResponse
    {
        public Dictionary<string, int> RoleDistribution { get; set; } = new();
        public int ActiveUsers { get; set; }
        public int InactiveUsers { get; set; }
        public int TotalUsers { get; set; }
    }
    
    private class StatsInfo
    {
        public int TotalUsers { get; set; }
        public int ActiveUsers { get; set; }
        public int InactiveUsers { get; set; }
        public Dictionary<string, int> RoleDistribution { get; set; } = new();
    }
    
    private class BulkChangeResponse
    {
        public int SuccessCount { get; set; }
        public int FailCount { get; set; }
        public string Message { get; set; } = string.Empty;
    }
}
