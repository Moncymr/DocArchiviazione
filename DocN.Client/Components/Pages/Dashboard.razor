@page "/dashboard"
@using DocN.Data.Services
@using DocN.Data.Models
@using DocN.Data.Constants
@using System.Security.Claims
@inject IDashboardWidgetService WidgetService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILogger<Dashboard> Logger
@rendermode InteractiveServer

<PageTitle>Dashboard - DocN</PageTitle>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h2>üìä Dashboard Documenti</h2>
        <button class="btn-manage" @onclick="ToggleWidgetManagement">
            ‚öôÔ∏è @(_isManagingWidgets ? "Chiudi" : "Gestisci Widget")
        </button>
    </div>

    @if (_isLoading)
    {
        <div class="loading">Caricamento dashboard...</div>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-error">
            <strong>‚ö†Ô∏è Errore</strong>
            <p>@_errorMessage</p>
        </div>
    }
    else
    {
        @if (_isManagingWidgets)
        {
            <div class="widget-management">
                <h3>Gestione Widget</h3>
                
                @if (_widgets?.Any() == true)
                {
                    <div class="widget-list">
                        @foreach (var widget in _widgets.OrderBy(w => w.Position))
                        {
                            <div class="widget-control-item">
                                <span class="widget-type-icon">@GetWidgetIcon(widget.WidgetType)</span>
                                <span class="widget-title">@widget.Title</span>
                                
                                <div class="widget-actions">
                                    <button class="btn-icon" @onclick="async () => await MoveWidgetUp(widget)" disabled="@(widget.Position == 0)" title="Sposta su">
                                        ‚¨ÜÔ∏è
                                    </button>
                                    <button class="btn-icon" @onclick="async () => await MoveWidgetDown(widget)" disabled="@(widget.Position == _widgets.Count - 1)" title="Sposta gi√π">
                                        ‚¨áÔ∏è
                                    </button>
                                    
                                    <label class="switch">
                                        <input type="checkbox" checked="@widget.IsVisible" @onchange="async (e) => await ToggleWidgetVisibility(widget, (bool)e.Value!)" />
                                        <span class="slider"></span>
                                    </label>
                                    
                                    <button class="btn-icon btn-delete" @onclick="async () => await DeleteWidget(widget)" title="Elimina">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                }

                <div class="add-widget-section">
                    <select class="select-widget-type" @bind="_selectedWidgetType">
                        <option value="">-- Seleziona tipo widget --</option>
                        <option value="Statistics">üìä Statistiche</option>
                        <option value="RecentDocuments">üìÑ Documenti Recenti</option>
                        <option value="ActivityFeed">üìà Feed Attivit√†</option>
                        <option value="SavedSearches">üîñ Ricerche Salvate</option>
                        @if (_isAdmin)
                        {
                            <option value="SystemHealth">üíö Stato Sistema</option>
                        }
                    </select>
                    <button class="btn-add" @onclick="AddWidget" disabled="@string.IsNullOrEmpty(_selectedWidgetType)">
                        ‚ûï Aggiungi Widget
                    </button>
                </div>
            </div>
        }

        @if (_widgets?.Any() == true)
        {
            <div class="widgets-grid">
                @foreach (var widget in _widgets.Where(w => w.IsVisible).OrderBy(w => w.Position))
                {
                    <div class="widget-container">
                        @switch (widget.WidgetType)
                        {
                            case "Statistics":
                                <StatisticsWidget WidgetId="@widget.Id" Title="@widget.Title" />
                                break;
                            case "RecentDocuments":
                                <RecentDocumentsWidget WidgetId="@widget.Id" Title="@widget.Title" />
                                break;
                            case "ActivityFeed":
                                <ActivityFeedWidget WidgetId="@widget.Id" Title="@widget.Title" />
                                break;
                            case "SavedSearches":
                                <SavedSearchesWidget WidgetId="@widget.Id" Title="@widget.Title" />
                                break;
                            case "SystemHealth":
                                <SystemHealthWidget WidgetId="@widget.Id" Title="@widget.Title" />
                                break;
                            default:
                                <div class="alert alert-warning">
                                    Widget type '@widget.WidgetType' non riconosciuto
                                </div>
                                break;
                        }
                    </div>
                }
            </div>
        }
        else if (!_isManagingWidgets)
        {
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Benvenuto</strong>
                <p>Nessun widget configurato. Clicca su "Gestisci Widget" per aggiungere widget personalizzati alla tua dashboard.</p>
            </div>
        }
    }
</div>

@code {
    private List<DashboardWidget>? _widgets;
    private bool _isLoading = true;
    private string? _userId;
    private string? _userRole;
    private string? _errorMessage;
    private bool _isManagingWidgets = false;
    private bool _isAdmin = false;
    private string _selectedWidgetType = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);
        _userRole = authState.User.FindFirstValue(ClaimTypes.Role);
        _isAdmin = _userRole == Roles.SuperAdmin || _userRole == Roles.TenantAdmin;

        await LoadWidgetsAsync();
    }

    private async Task LoadWidgetsAsync()
    {
        try
        {
            _isLoading = true;
            _errorMessage = null;

            if (string.IsNullOrEmpty(_userId))
            {
                _errorMessage = "Utente non autenticato";
                return;
            }

            _widgets = await WidgetService.GetUserWidgetsAsync(_userId);

            // If user has no widgets, initialize with defaults based on role
            if (!_widgets.Any() && !string.IsNullOrEmpty(_userRole))
            {
                await InitializeDefaultWidgets();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading dashboard widgets for user {UserId}", _userId);
            _errorMessage = "Si √® verificato un errore durante il caricamento della dashboard.";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task InitializeDefaultWidgets()
    {
        try
        {
            var defaultWidgets = await WidgetService.GetDefaultWidgetsForRole(_userRole!);
            
            foreach (var widget in defaultWidgets)
            {
                widget.UserId = _userId!;
                await WidgetService.CreateWidgetAsync(widget);
            }

            _widgets = await WidgetService.GetUserWidgetsAsync(_userId!);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing default widgets for user {UserId}", _userId);
        }
    }

    private void ToggleWidgetManagement()
    {
        _isManagingWidgets = !_isManagingWidgets;
        StateHasChanged();
    }

    private async Task ToggleWidgetVisibility(DashboardWidget widget, bool isVisible)
    {
        try
        {
            widget.IsVisible = isVisible;
            await WidgetService.UpdateWidgetAsync(widget);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling widget visibility");
            _errorMessage = "Errore nell'aggiornamento del widget";
        }
    }

    private async Task MoveWidgetUp(DashboardWidget widget)
    {
        if (widget.Position == 0 || _widgets == null) return;

        var otherWidget = _widgets.FirstOrDefault(w => w.Position == widget.Position - 1);
        if (otherWidget != null)
        {
            widget.Position--;
            otherWidget.Position++;

            try
            {
                await WidgetService.UpdateWidgetAsync(widget);
                await WidgetService.UpdateWidgetAsync(otherWidget);
                await LoadWidgetsAsync();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error moving widget up");
                _errorMessage = "Errore nello spostamento del widget";
            }
        }
    }

    private async Task MoveWidgetDown(DashboardWidget widget)
    {
        if (_widgets == null || widget.Position == _widgets.Count - 1) return;

        var otherWidget = _widgets.FirstOrDefault(w => w.Position == widget.Position + 1);
        if (otherWidget != null)
        {
            widget.Position++;
            otherWidget.Position--;

            try
            {
                await WidgetService.UpdateWidgetAsync(widget);
                await WidgetService.UpdateWidgetAsync(otherWidget);
                await LoadWidgetsAsync();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error moving widget down");
                _errorMessage = "Errore nello spostamento del widget";
            }
        }
    }

    private async Task DeleteWidget(DashboardWidget widget)
    {
        try
        {
            await WidgetService.DeleteWidgetAsync(widget.Id, _userId!);
            await LoadWidgetsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting widget");
            _errorMessage = "Errore nell'eliminazione del widget";
        }
    }

    private async Task AddWidget()
    {
        if (string.IsNullOrEmpty(_selectedWidgetType) || string.IsNullOrEmpty(_userId) || _widgets == null)
            return;

        try
        {
            var newWidget = new DashboardWidget
            {
                UserId = _userId,
                WidgetType = _selectedWidgetType,
                Title = GetWidgetTitle(_selectedWidgetType),
                Position = _widgets.Count,
                IsVisible = true
            };

            await WidgetService.CreateWidgetAsync(newWidget);
            _selectedWidgetType = "";
            await LoadWidgetsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error adding widget");
            _errorMessage = "Errore nell'aggiunta del widget";
        }
    }

    private string GetWidgetTitle(string widgetType)
    {
        return widgetType switch
        {
            "Statistics" => "Statistiche Documenti",
            "RecentDocuments" => "Documenti Recenti",
            "ActivityFeed" => "Attivit√† Recenti",
            "SavedSearches" => "Ricerche Salvate",
            "SystemHealth" => "Stato Sistema",
            _ => widgetType
        };
    }

    private string GetWidgetIcon(string widgetType)
    {
        return widgetType switch
        {
            "Statistics" => "üìä",
            "RecentDocuments" => "üìÑ",
            "ActivityFeed" => "üìà",
            "SavedSearches" => "üîñ",
            "SystemHealth" => "üíö",
            _ => "üì¶"
        };
    }
}

<style>
    .dashboard-container {
        padding: 2rem;
        max-width: 1600px;
        margin: 0 auto;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .dashboard-header h2 {
        margin: 0;
        font-size: 2rem;
    }

    .btn-manage {
        padding: 0.75rem 1.5rem;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .btn-manage:hover {
        background: #1d4ed8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .loading {
        text-align: center;
        padding: 3rem;
        color: #666;
        font-size: 1.1rem;
    }

    .alert {
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }

    .alert-error {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        color: #721c24;
        border: 2px solid #dc3545;
        border-left: 5px solid #dc3545;
    }

    .alert-info {
        background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        color: #0c5460;
        border: 2px solid #17a2b8;
        border-left: 5px solid #17a2b8;
    }

    .alert-warning {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
        color: #856404;
        border: 2px solid #ffc107;
        border-left: 5px solid #ffc107;
    }

    .alert strong {
        display: block;
        margin-bottom: 0.5rem;
    }

    .widget-management {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .widget-management h3 {
        margin: 0 0 1.5rem 0;
        font-size: 1.3rem;
        color: #333;
    }

    .widget-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .widget-control-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .widget-type-icon {
        font-size: 1.5rem;
    }

    .widget-title {
        flex: 1;
        font-weight: 500;
        color: #333;
    }

    .widget-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .btn-icon {
        padding: 0.5rem;
        background: none;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .btn-icon:hover:not(:disabled) {
        background: #e9ecef;
    }

    .btn-icon:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .btn-delete {
        border-color: #dc3545;
    }

    .btn-delete:hover:not(:disabled) {
        background: #f8d7da;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: #2563eb;
    }

    input:checked + .slider:before {
        transform: translateX(26px);
    }

    .add-widget-section {
        display: flex;
        gap: 1rem;
        padding-top: 1rem;
        border-top: 2px solid #e9ecef;
    }

    .select-widget-type {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-size: 1rem;
    }

    .btn-add {
        padding: 0.75rem 1.5rem;
        background: #198754;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .btn-add:hover:not(:disabled) {
        background: #157347;
    }

    .btn-add:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .widgets-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
    }

    .widget-container {
        min-height: 300px;
    }

    @@media (max-width: 768px) {
        .dashboard-header {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }

        .widgets-grid {
            grid-template-columns: 1fr;
        }

        .widget-actions {
            flex-wrap: wrap;
        }
    }
</style>
